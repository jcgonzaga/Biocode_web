---
import SubscribeForm from '../components/SubscribeForm.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import Footer from '../components/Footer.astro';
import { supabase } from '../lib/supabase';

// Fetch only the two latest newsletters for the homepage
const { data: latestNewsletters, error } = await supabase
  .from('newsletters')
  .select('id, subject, publication_date, content_html, image_url')
  .order('publication_date', { ascending: false })
  .limit(1);

if (error) {
  console.error('Error fetching latest newsletters:', error);
}

function createExcerpt(html: string, length = 100) {
    if (!html) return '';

    // 1. Remove <style> tags and their content
    let cleanHtml = html.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');

    let text = '';
    // 2. Find all paragraph tags
    const allParagraphMatches = [...cleanHtml.matchAll(/<p[^>]*>([\s\S]*?)<\/p>/gi)];

    // 3. Try to get the content of the second paragraph
    if (allParagraphMatches.length >= 2 && allParagraphMatches[1][1]) {
        text = allParagraphMatches[1][1].replace(/<[^>]*>/g, ' ');
    } else if (allParagraphMatches.length >= 1 && allParagraphMatches[0][1]) {
        // Fallback to the first paragraph if only one exists
        text = allParagraphMatches[0][1].replace(/<[^>]*>/g, ' ');
    } else {
        // Fallback: if no paragraph found, strip all HTML from the cleaned content
        text = cleanHtml.replace(/<[^>]*>/g, ' ');
    }

    text = text.replace(/\s+/g, ' ').trim(); // Normalize whitespace

    if (text.length <= length) return text;
    return text.slice(0, length) + '...';
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Biocode Newsletter</title>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <Header />
    <main class="container mx-auto p-8">
      <Hero />

      <section class="text-center my-12 p-8 bg-gradient-main text-pure-white rounded-lg shadow-lg">
        <h2 class="text-4xl font-bold mb-4">Cada semana, la ciencia más puntera en biohacking y longevidad.</h2>
        <p class="text-xl max-w-3xl mx-auto">Destilada en consejos prácticos para tu máximo rendimiento. Deja de buscar, empieza a optimizar.</p>
      </section>

      <section id="subscribe" class="flex justify-center">
        <div class="w-full lg:w-1/2 bg-white p-8 rounded-lg shadow-md">
          <h2 class="text-2xl font-bold text-center mb-6">Subscríbete</h2>
          <SubscribeForm />
        </div>
      </section>

      <section class="my-12">
        <h2 class="text-3xl font-bold mb-6 text-center text-deep-blue">Nuestras Últimas Ediciones</h2>
        <div class="flex justify-center">
          {latestNewsletters && latestNewsletters.map(newsletter => (
            <a href={`/newsletters/${newsletter.id}`} class="block md:w-1/2 bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 transform hover:-translate-y-1">
              {newsletter.image_url && <img src={newsletter.image_url} alt={newsletter.subject} class="w-full h-48 object-cover rounded-t-lg mb-4" />}
              <p class="text-sm text-gray-500 mb-2">{new Date(newsletter.publication_date).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <h3 class="text-xl font-semibold text-emerald-green mb-2">{newsletter.subject}</h3>
              <p class="text-gray-600">{createExcerpt(newsletter.content_html)}</p>
            </a>
          ))}
        </div>
        {latestNewsletters && latestNewsletters.length === 0 && (
          <p class="text-center text-gray-600">No hay newsletters disponibles por el momento.</p>
        )}
      </section>
    </main>
    <Footer />
  </body>
</html>
